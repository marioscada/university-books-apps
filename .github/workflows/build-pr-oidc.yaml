# =============================================================================
# BUILD PR con OIDC - Versione Sicura (RACCOMANDATO)
# =============================================================================
# Questa versione usa AWS OIDC per autenticazione senza secrets statici.
# √à il metodo raccomandato da AWS per GitHub Actions.
#
# PREREQUISITI:
# 1. Configura OIDC provider in AWS (vedi AWS-SETUP.md)
# 2. Crea IAM Role con trust policy per il tuo repo
# 3. Aggiungi il secret AWS_ROLE_ARN
#
# PERSONALIZZAZIONE:
# - Sostituisci tutti i {{PLACEHOLDER}} con i tuoi valori
# =============================================================================

name: Build Pull Request (OIDC)

on: [pull_request]

# Permessi necessari per OIDC
permissions:
  id-token: write   # Richiesto per OIDC
  contents: read
  pull-requests: write

jobs:
  pr-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['{{NODE_VERSION}}']

    steps:
      - name: Print payload
        run: echo "$PAYLOAD"
        env:
          PAYLOAD: ${{ toJSON(github) }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # =========================================================================
      # CACHE & SETUP
      # =========================================================================
      - name: Cache node modules
        id: cache-nodemodules
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: |
            node_modules
            */*/node_modules
            ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install Dependencies
        if: steps.cache-nodemodules.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline --no-audit

      # =========================================================================
      # DETECT CHANGES
      # =========================================================================
      - name: Get BASE & HEAD SHA
        run: |
          echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV
          echo "HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV

      - name: Detect Changed Projects
        run: |
          echo "CHANGED_PROJECT_1=$(git diff-tree --numstat --no-commit-id -r ${{ env.BASE_SHA }} ${{ env.HEAD_SHA }} -- ./projects/{{PROJECT_1}} | head -n 1 )" >> $GITHUB_ENV
          echo "CHANGED_PROJECT_2=$(git diff-tree --numstat --no-commit-id -r ${{ env.BASE_SHA }} ${{ env.HEAD_SHA }} -- ./projects/{{PROJECT_2}} | head -n 1 )" >> $GITHUB_ENV
          echo "CHANGED_PROJECT_3=$(git diff-tree --numstat --no-commit-id -r ${{ env.BASE_SHA }} ${{ env.HEAD_SHA }} -- ./projects/{{PROJECT_3}} | head -n 1 )" >> $GITHUB_ENV

      - name: Show Changed Projects
        run: |
          echo "Changed projects:"
          [ -n "$CHANGED_PROJECT_1" ] && echo "  - {{PROJECT_1}}" || true
          [ -n "$CHANGED_PROJECT_2" ] && echo "  - {{PROJECT_2}}" || true
          [ -n "$CHANGED_PROJECT_3" ] && echo "  - {{PROJECT_3}}" || true

      # =========================================================================
      # BUILD
      # =========================================================================
      - name: Build Shared Libraries
        if: env.CHANGED_PROJECT_1 != '' || env.CHANGED_PROJECT_2 != '' || env.CHANGED_PROJECT_3 != ''
        run: npm run build:libs

      - name: Build {{PROJECT_1}}
        if: env.CHANGED_PROJECT_1 != ''
        run: |
          npm run i18n:cache-busting {{PROJECT_1}} || true
          npm run build:{{PROJECT_1}} -- --configuration=production
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Build {{PROJECT_2}}
        if: env.CHANGED_PROJECT_2 != ''
        run: |
          npm run i18n:cache-busting {{PROJECT_2}} || true
          npm run build:{{PROJECT_2}} -- --configuration=production
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      - name: Build {{PROJECT_3}}
        if: env.CHANGED_PROJECT_3 != ''
        run: |
          npm run i18n:cache-busting {{PROJECT_3}} || true
          npm run build:{{PROJECT_3}} -- --configuration=production
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'

      # =========================================================================
      # AWS AUTHENTICATION (OIDC)
      # =========================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: {{S3_REGION}}
          role-session-name: github-actions-${{ github.run_id }}

      - name: Verify AWS Identity
        run: aws sts get-caller-identity

      # =========================================================================
      # DEPLOY
      # =========================================================================
      - name: Deploy to S3
        run: npm run upload
        env:
          PR_SHA: ${{ github.sha }}
          REF: ${{ github.ref }}
          CHANGED_PROJECT_1: ${{ env.CHANGED_PROJECT_1 }}
          CHANGED_PROJECT_2: ${{ env.CHANGED_PROJECT_2 }}
          CHANGED_PROJECT_3: ${{ env.CHANGED_PROJECT_3 }}

      # =========================================================================
      # PR COMMENT
      # =========================================================================
      - name: Find Deploy URL Comment
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Deploy Preview

      - name: Create or Update Deploy URL
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üöÄ Deploy Preview

            | Project | Status | Preview URL |
            |---------|--------|-------------|
            | {{PROJECT_1}} | ${{ env.CHANGED_PROJECT_1 != '' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | [Open](http://${{ github.sha }}.dev.{{PROJECT_1}}.{{S3_BUCKET_BASE}}.s3-website-{{S3_REGION}}.amazonaws.com) |
            | {{PROJECT_2}} | ${{ env.CHANGED_PROJECT_2 != '' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | [Open](http://${{ github.sha }}.dev.{{PROJECT_2}}.{{S3_BUCKET_BASE}}.s3-website-{{S3_REGION}}.amazonaws.com) |
            | {{PROJECT_3}} | ${{ env.CHANGED_PROJECT_3 != '' && '‚úÖ Built' || '‚è≠Ô∏è Skipped' }} | [Open](http://${{ github.sha }}.dev.{{PROJECT_3}}.{{S3_BUCKET_BASE}}.s3-website-{{S3_REGION}}.amazonaws.com) |

            ---
            <details>
            <summary>‚ÑπÔ∏è Build Info</summary>

            - **Commit**: `${{ github.sha }}`
            - **Branch**: `${{ github.head_ref }}`
            - **Author**: @${{ github.actor }}
            - **Workflow**: [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            </details>
          edit-mode: replace
