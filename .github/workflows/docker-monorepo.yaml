# =============================================================================
# Docker Monorepo - Build solo progetti modificati
# =============================================================================

name: Docker Monorepo Build

on:
  pull_request:
  push:
    branches: [master]

jobs:
  # Detect quali progetti sono stati modificati
  detect-changes:
    name: Detect Changed Projects
    runs-on: ubuntu-latest
    outputs:
      university-books-mobile: ${{ steps.filter.outputs.university-books-mobile }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            university-books-mobile:
              - 'projects/university-books-mobile/**'
              - 'libs/**'
              - 'package*.json'
              - 'angular.json'

  # Build University Books Mobile
  build-university-books-mobile:
    name: Build University Books Mobile
    needs: detect-changes
    if: needs.detect-changes.outputs.university-books-mobile == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build University Books Mobile
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile.monorepo
          push: false
          load: true
          tags: university-books-mobile:latest
          build-args: |
            PROJECT_NAME=university-books-mobile
            BUILD_CONFIGURATION=production
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test University Books Mobile
        run: |
          docker run -d -p 8080:80 --name test-university-books-mobile university-books-mobile:latest
          sleep 5
          curl -f http://localhost:8080/ || exit 1
          docker stop test-university-books-mobile

  # Summary
  build-summary:
    name: Build Summary
    needs: [detect-changes, build-university-books-mobile]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Project | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| University Books Mobile | ${{ needs.detect-changes.outputs.university-books-mobile }} | ${{ needs.build-university-books-mobile.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
