# =============================================================================
# BUILD MASTER - Build Completo su Master
# =============================================================================
# Questo workflow esegue il build completo di tutti i progetti quando si fa
# push su master. Include anche Sentry release per error tracking.
#
# PERSONALIZZAZIONE:
# - Sostituisci {{NODE_VERSION}} con la tua versione Node
# - Sostituisci {{PROJECT_1}}, {{PROJECT_2}}, {{PROJECT_3}} con i nomi progetti
# - Configura i secrets S3 e Sentry
# =============================================================================

name: Build Master

on:
  push:
    branches:
      - master

jobs:
  master-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['{{NODE_VERSION}}']

    steps:
      - name: Print payload
        run: echo "$PAYLOAD"
        env:
          PAYLOAD: ${{ toJSON(github) }}

      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache node modules
        id: cache-nodemodules
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          path: |
            node_modules
            */*/node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - name: Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install Dependencies
        if: steps.cache-nodemodules.outputs.cache-hit != 'true'
        run: npm ci

      # =============================================================================
      # BUILD LIBRARIES - Prima le librerie condivise
      # =============================================================================
      - name: Build Shared Libraries
        run: npm run build:libs

      # =============================================================================
      # BUILD ALL PROJECTS - Tutti i progetti
      # =============================================================================
      - name: i18n cache busting - {{PROJECT_1}}
        run: npm run i18n:cache-busting {{PROJECT_1}} || true

      - name: Build {{PROJECT_1}}
        run: npm run build:{{PROJECT_1}}

      - name: i18n cache busting - {{PROJECT_2}}
        run: npm run i18n:cache-busting {{PROJECT_2}} || true

      - name: Build {{PROJECT_2}}
        run: npm run build:{{PROJECT_2}}

      - name: i18n cache busting - {{PROJECT_3}}
        run: npm run i18n:cache-busting {{PROJECT_3}} || true

      - name: Build {{PROJECT_3}}
        run: npm run build:{{PROJECT_3}}

      # =============================================================================
      # SENTRY - Error tracking (opzionale)
      # =============================================================================
      - name: Sentry release
        run: npm run sentry:release || true
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}

      # =============================================================================
      # DEPLOY - Upload su S3
      # =============================================================================
      - name: Deploy on S3
        run: npm run upload
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
          PR_SHA: ${{ github.sha }}
          REF: ${{ github.ref }}
          # Flag per indicare che tutti i progetti sono stati compilati
          CHANGED_PROJECT_1: true
          CHANGED_PROJECT_2: true
          CHANGED_PROJECT_3: true

      # =============================================================================
      # NOTIFICHE (opzionale)
      # =============================================================================
      # - name: Notify Slack
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     fields: repo,message,commit,author,action,eventName,ref,workflow
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      #   if: always()
